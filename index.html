<!DOCTYPE html>
<html>
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JDYFTFF29L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JDYFTFF29L');
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Market Clock</title>
<link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
<link rel="apple-touch-icon" href="favicon.ico?v=2">
<style>
/* (same CSS as your original, kept concise) */
* { transition: background-color 0.2s ease, color 0.2s ease; }
:root.dark body{ background:#111; color:#fff; }
:root.light body{ background:#f5f5f5; color:#111; }
body{ margin:0; padding:40px; font-family:Arial,Helvetica,sans-serif; text-align:center; }
#pageTitle{ font-size:28px; font-weight:600; margin-bottom:20px; opacity:0.9; }
#timezone{ margin-bottom:30px; font-size:16px; opacity:0.8; }
#searchBar{ max-width:320px; width:100%; padding:10px 14px; border-radius:8px; border:1px solid #ccc; font-size:15px; margin:0 auto 16px auto; display:block; box-shadow:0 1px 4px rgba(0,0,0,0.12); }
#searchBar:focus{ outline:2px solid #4caf50; border-color:#4caf50; }
#themeToggle{ position:fixed; top:20px; right:20px; padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
:root.dark #themeToggle{ background:#444; color:#fff; }
:root.light #themeToggle{ background:#ddd; color:#000; }
#controlButtons{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:15px; }
#controlButtons button{ padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
:root.dark #controlButtons button{ background:#444; color:#fff; }
:root.light #controlButtons button{ background:#ddd; color:#000; }
#utcToggle{ background: none; padding: 6px 12px; font-size: 13px; opacity: 0.8; }
:root.dark #utcToggle{ color: #fff; }
:root.light #utcToggle{ color: #000; }
#alertModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; }
#alertModalContent { background: #fff; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 90%; }
:root.dark #alertModalContent { background: #222; color: #fff; }
#alertModalContent h2 { margin-top: 0; }
.alert-market { margin-bottom: 20px; padding: 15px; border-radius: 8px; background: rgba(0,0,0,0.05); }
:root.dark .alert-market { background: rgba(255,255,255,0.05); }
.alert-market h3 { margin: 0 0 10px 0; font-size: 16px; }
.alert-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
.alert-controls label { min-width: 120px; }
.alert-controls input[type="number"] { width: 60px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; }
.alert-controls select { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; }
:root.dark .alert-controls input, :root.dark .alert-controls select { background: #333; color: #fff; border-color: #555; }
.alert-controls input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
#closeAlertModal { margin-top: 20px; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; background: #444; color: #fff; }
:root.light #closeAlertModal { background: #ddd; color: #000; }
#top{margin-bottom:40px} #clock{font-size:72px;font-weight:bold} #date{font-size:16px;opacity:.8}
#categories{ max-width:1100px; margin:0 auto; text-align:left; }
.market-grid{ display:grid; grid-template-columns:1fr; gap:24px; }
@media (min-width:900px){ .market-grid{ grid-template-columns:1fr 1fr; column-gap:28px; row-gap:24px; } }
.market { font-size:18px; padding:16px 18px; padding-right:50px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.25); background:rgba(0,0,0,0.1); position:relative; user-select: none; -webkit-user-select: none; transition: background-color 0.2s ease, box-shadow 0.2s ease; }
.market.dragging { user-select: none; }:root.dark .market{ background:#1a1a1a; box-shadow:0 2px 10px rgba(0,0,0,0.6); }
:root.dark .open{color:#4caf50} :root.dark .closed{color:#e53935}
:root.light .open{color:#2e7d32} :root.light .closed{color:#c62828}
:root.dark .market.open{ background:#1a2e1a; }
:root.light .market.open{ background:rgba(46, 125, 50, 0.08); }
:root.dark .market.closed{ background:#1a1a1a; }
:root.light .market.closed{ background:rgba(0,0,0,0.1); }
.timeline{ margin-top:8px; height:22px; border-radius:6px; position:relative; overflow:hidden; }
:root.dark .timeline{background:#333} :root.light .timeline{background:#ddd}
.seg{ position:absolute; top:0; height:100%; transition:filter 0.2s ease; }
.seg:hover{ filter:brightness(1.25); }
.pre{background:#9c27b0} .regular{background:#4caf50} .after{background:#2196f3} .overnight{background:#0d1b3d}
.now{ position:absolute; top:-10px; bottom:-10px; width:4px; background:#ff0000; box-shadow:0 0 6px #ff0000; transition:left 1s linear; }
.now:after{ content:"▼"; position:absolute; top:-16px; left:-7px; color:#ff0000; font-size:16px; }
#legend{ margin-top:40px; font-size:16px; } .legend-item{ display:inline-flex; align-items:center; margin:0 12px; }
.legend-box{ width:18px; height:18px; margin-right:6px; border-radius:4px; }
#shareContainer{ margin-top:30px; text-align:center; } #shareBtn{ padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:16px; }
:root.dark #shareBtn{ background:#444; color:#fff; } :root.light #shareBtn{ background:#ddd; color:#000; }
#reorderControls { margin-top: 10px; } #resetOrderBtn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
:root.dark #resetOrderBtn { background: #444; color: #fff; } :root.light #resetOrderBtn { background: #ddd; color: #000; }
#feedbackButtons { margin-top: 20px; text-align: center; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
#feedbackButtons button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; }
:root.dark #feedbackButtons button { background: #444; color: #fff; } :root.light #feedbackButtons button { background: #ddd; color: #000; }
#seoContent { margin-top: 60px; padding: 20px; font-size: 14px; opacity: 0.7; line-height: 1.6; text-align: center; max-width: 900px; margin-left: auto; margin-right: auto; }
#categories { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }
.category-block { background: rgba(0,0,0,0.06); border-radius: 10px; padding: 14px 16px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
:root.dark .category-block { background: #161616; box-shadow:0 2px 10px rgba(0,0,0,0.35); }
.category-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.category-title { font-size: 18px; font-weight: 600; }
.category-toggle { border: 1px solid #999; background: #f0f0f0; color: #111; font-size: 14px; cursor: pointer; opacity: 0.95; padding: 6px 12px; border-radius: 6px; }
:root.dark .category-toggle { border-color: #666; background: #333; color: #fff; }
.category-toggle:hover { filter: brightness(1.08); }
.category-toggle:focus-visible { outline: 2px solid #4caf50; outline-offset: 2px; }
.category-content { margin-top: 10px; display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 900px){ .category-content { grid-template-columns: 1fr 1fr; } }
.category-collapsed .category-content { display: none; }
.pill-list { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
.pill { padding: 6px 10px; border-radius: 999px; background: rgba(0,0,0,0.08); font-size: 13px; }
:root.dark .pill { background: rgba(255,255,255,0.06); }
#myMarketsEmpty { font-size: 14px; opacity: 0.7; margin: 6px 0 2px 0; }
#logoContainer { position: fixed; left: 20px; top: 20px; z-index: 100; }
#logo { max-width: 300px; height: auto; display: block; }
#openMarketsSidebar { position: fixed; left: 0; top: 120px; width: 200px; padding: 15px; background: rgba(0,0,0,0.15); backdrop-filter: blur(6px); border-radius: 0 8px 8px 0; font-size: 15px; text-align:left; }
:root.light #openMarketsSidebar { background: rgba(255,255,255,0.6); } #openMarketsSidebar h3 { margin-top: 0; font-size: 17px; }
#openMarketsList, #openingSoonList, #closingSoonList { list-style: none; padding-left: 0; margin: 0; }
#openMarketsList li, #openingSoonList li, #closingSoonList li { margin-bottom: 6px; }
.market.dragging { opacity: 0.6; transform: scale(1.03); box-shadow: 0 6px 18px rgba(0,0,0,0.35); z-index: 10; }
.market.placeholder { border: 2px dashed #888; background: transparent !important; height: 80px; }
.open-dot { margin-left:6px; font-size:0.95em; vertical-align:middle; }
.reorder-arrows { display: none; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); flex-direction: column; gap: 4px; }
.reorder-arrows button { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; padding: 0; }
:root.dark .reorder-arrows button { background: #333; color: #fff; }
:root.light .reorder-arrows button { background: #ccc; color: #000; }
.reorder-arrows button:active { opacity: 0.7; }
.favorite-btn { position: absolute; right: 12px; top: 12px; width: 32px; height: 32px; border: none; background: transparent; cursor: pointer; font-size: 20px; padding: 0; z-index: 5; transition: transform 0.2s ease; pointer-events: auto; }
.favorite-btn:hover { transform: scale(1.2); }
.favorite-btn.favorited { color: #ffd700; }
.favorite-btn:not(.favorited) { color: #888; opacity: 0.6; }
:root.dark .favorite-btn:not(.favorited) { color: #666; }

/* MOBILE / SMALL SCREEN OPTIMIZATIONS */
@media (max-width: 900px) {
  body {
    padding: 12px;
    text-align: left;
    display: flex;
    flex-direction: column;
  }
  /* Logo adjustments for mobile - move to top */
  #logoContainer {
    position: static;
    text-align: center;
    margin-bottom: 12px;
    order: -1;
  }
  #logo {
    max-width: 240px;
    margin: 0 auto;
    display: block;
    width: 100%;
    height: auto;
  }
  /* move top buttons into flow so they don't overlap content */
  #themeToggle {
    position: static;
    display: inline-block;
    margin: 6px 8px;
    right: auto;
    top: auto;
  }
  /* make title and timezone stack compactly */
  #pageTitle { font-size: 20px; margin-top: 8px; }
  #timezone { font-size: 14px; margin-bottom: 10px; }

  /* Sidebar becomes a full-width block above markets */
  #openMarketsSidebar {
    position: static;
    left: auto;
    top: auto;
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  #openMarketsSidebar h3 { margin: 0; font-size: 15px; }
  #openMarketsList, #openingSoonList {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  #openMarketsList li, #openingSoonList li {
    margin: 0;
    padding: 6px 8px;
    border-radius: 999px;
    font-weight: 600;
    background: rgba(255,255,255,0.03);
    align-items: center;
    display: inline-flex;
    gap: 6px;
  }

  /* markets adjust to single column and tighter spacing */
  .market-grid {
    grid-template-columns: 1fr !important;
    gap: 12px;
  }
  .market {
    font-size: 16px;
    padding: 12px;
    padding-right: 90px;
    border-radius: 8px;
    cursor: default;
  }
  .reorder-arrows { display: flex; right: 12px; }
  .favorite-btn { right: 52px; top: 50%; transform: translateY(-50%); }
  .favorite-btn:hover { transform: translateY(-50%) scale(1.2); }
  .timeline { height: 28px; }

  /* reduce clock size */
  #clock { font-size: 36px; }
  #date { font-size: 13px; }

  /* legend and large controls moved to compact layout */
  #legend { display: none; }
  #shareContainer, #reorderControls { display: flex; gap: 8px; flex-wrap: wrap; justify-content: stretch; }
  #shareBtn, #resetOrderBtn { flex: 1; }

  /* ensure placeholder and dragging layers behave nicely */
  .market.dragging { position: fixed; left: 0; right: 0; margin: 0 auto; width: calc(100% - 24px); }
  .market.placeholder { height: 72px; }

  /* ensure the markets container has proper padding on small screens */
  #categories { padding-top: 6px; }

  /* avoid fixed overlapping on very small screens */
  @media (max-width: 420px) {
    #themeToggle, #controlButtons button { font-size: 13px; padding: 6px 10px; }
    #clock { font-size: 28px; }
    body { padding: 10px; }
  }
}
</style>
</head>
<body>
<button id="themeToggle">Dark</button>

<div id="pageTitle">Market Clock – Live Global Market Open/Close Times</div>
<div id="timezone"></div>
<input id="searchBar" type="search" placeholder="Search markets, countries, tickers..." aria-label="Search markets">

<div id="top">
  <div id="clock"></div>
  <div id="date"></div>
  <button id="utcToggle" style="margin-top: 10px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Show UTC</button>
  <div id="controlButtons">
    <button id="tzToggle">Show Market Local Times</button>
    <button id="filterToggle">Show Open First</button>
    <button id="favoriteToggle">Show Favorites Only</button>
    <button id="alertToggle">Alert Settings</button>
  </div>
</div>

<!-- LOGO -->
<div id="logoContainer">
  <img src="./Market4.png" alt="Logo" id="logo">
</div>

<!-- LEFT SIDEBAR -->
<div id="openMarketsSidebar">
  <h3>Open Markets</h3>
  <ul id="openMarketsList"></ul>
  <h3>Opening Soon</h3>
<ul id="openingSoonList"></ul>
  <h3>Closing Soon</h3>
  <ul id="closingSoonList"></ul>
</div>

<!-- ALERT SETTINGS MODAL -->
<div id="alertModal" style="display:none;">
  <div id="alertModalContent">
    <h2>Alert Settings</h2>
    <div id="alertSettingsContainer"></div>
    <button id="closeAlertModal">Close</button>
  </div>
</div>

<!-- Markets container (sections built dynamically) -->
<div id="categories"></div>

<div id="legend">
  <div class="legend-item"><div class="legend-box" style="background:#9c27b0"></div>Pre‑Market</div>
  <div class="legend-item"><div class="legend-box" style="background:#4caf50"></div>Regular Hours</div>
  <div class="legend-item"><div class="legend-box" style="background:#2196f3"></div>After Hours</div>
  <div class="legend-item"><div class="legend-box" style="background:#0d1b3d"></div>Overnight</div>
</div>

<div id="reorderControls">
  <button id="resetOrderBtn">Reset Order</button>
</div>

<div id="shareContainer">
  <button id="shareBtn">Share</button>
</div>

<div id="feedbackButtons">
  <button id="reportHoursBtn">Report Incorrect Market Hours</button>
  <button id="feedbackBtn">Send Feedback</button>
</div>

<div id="seoContent">
  <p>MarketClock provides live global market hours and real‑time opening and closing times for major stock exchanges worldwide, including New York (NYSE & NASDAQ), London Stock Exchange (LSE), Frankfurt Xetra, Euronext Paris, Tokyo Stock Exchange (TSE), Hong Kong Stock Exchange (HKEX), Shanghai Stock Exchange (SSE), Singapore Exchange (SGX), India's National Stock Exchange (NSE), Sydney's ASX, Toronto Stock Exchange (TSX), and Brazil's B3. Track worldwide trading sessions, market status updates, countdowns to the next open or close, and key international market overlaps in one simple, fast, and accurate global market clock. Designed for traders, investors, and anyone following international stock market times.</p>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* THEME TOGGLE */
  const root = document.documentElement;
  const toggle = document.getElementById("themeToggle");
  root.classList.add("dark");
  toggle.textContent = "Light";
  toggle.addEventListener("click", () => {
    if (root.classList.contains("dark")) {
      root.classList.remove("dark");
      root.classList.add("light");
      toggle.textContent = "Dark";
    } else {
      root.classList.remove("light");
      root.classList.add("dark");
      toggle.textContent = "Light";
    }
  });

  /* SHARE BUTTON */
  const shareBtn = document.getElementById("shareBtn");
  function fallbackPrompt(url){ alert("Share this link:\n\n" + url); }
  shareBtn.addEventListener("click", () => {
    const url = window.location.href;
    const shareData = { title: "Market Clock", text: "Check out this live global market clock!", url };
    if (navigator.share) { navigator.share(shareData).catch(()=>{}); return; }
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).then(()=> {
        const prev = shareBtn.textContent;
        shareBtn.textContent = "Copied!";
        setTimeout(()=> shareBtn.textContent = prev, 1500);
      }).catch(()=> fallbackPrompt(url));
    } else { fallbackPrompt(url); }
  });

  /* TIME HELPERS */
  function utcSec(){
    const d=new Date();
    return d.getUTCHours()*3600 + d.getUTCMinutes()*60 + d.getUTCSeconds();
  }
  function pct(x){ return (x/86400)*100; }
  function format(sec){ sec=Math.max(0,Math.floor(sec)); return Math.floor(sec/3600)+"h "+Math.floor((sec%3600)/60)+"m "+(sec%60)+"s"; }
  function inRange(t,a,b){ if(b>a) return t>=a && t<b; return t>=a || t<b; }
  function secsToHMS(sec){
    sec = Math.floor(sec);
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    return {h,m,s};
  }
  function parseHHMM(str){ const [h,m] = str.split(":").map(Number); return (h*3600)+(m*60); }
  function getTzOffsetSeconds(tz){
    const now = new Date();
    const tzDate = new Date(now.toLocaleString("en-US", { timeZone: tz }));
    return (tzDate.getTime() - now.getTime()) / 1000; // positive if TZ ahead of UTC
  }
  function applyLocalTimes(m){
    if (!m.useLocalTime || !m.tz) return m;
    const offset = getTzOffsetSeconds(m.tz);

    // Helper to shift a local HH:MM to UTC seconds-of-day
    const toUtcSec = (hhmm) => (parseHHMM(hhmm) - offset + 86400) % 86400;

    if (m.localOpen1 && m.localClose1 && m.localOpen2 && m.localClose2) {
      m.open1 = toUtcSec(m.localOpen1);
      m.close1 = toUtcSec(m.localClose1);
      m.open2 = toUtcSec(m.localOpen2);
      m.close2 = toUtcSec(m.localClose2);
    } else if (m.localOpen && m.localClose) {
      m.open = toUtcSec(m.localOpen);
      m.close = toUtcSec(m.localClose);
    }
    return m;
  }

  /* HOLIDAYS - Market closures for US and international exchanges */
  function isMarketHoliday(date, marketId) {
    const year = date.getUTCFullYear();
    const month = date.getUTCMonth() + 1;
    const day = date.getUTCDate();
    const dayOfWeek = date.getUTCDay();
    
    // Helper to calculate nth weekday of month (e.g., 3rd Monday)
    function getNthWeekday(y, m, weekday, n) {
      let d = new Date(Date.UTC(y, m - 1, 1));
      let count = 0;
      while (count < n) {
        if (d.getUTCDay() === weekday) count++;
        if (count < n) d.setUTCDate(d.getUTCDate() + 1);
      }
      return d.getUTCDate();
    }
    
    // US market holidays (NYSE, NASDAQ)
    if (marketId === "nyse") {
      // New Year's Day
      if (month === 1 && day === 1) return true;
      // MLK Day (3rd Monday of January)
      if (month === 1 && day === getNthWeekday(year, 1, 1, 3)) return true;
      // Presidents Day (3rd Monday of February)
      if (month === 2 && day === getNthWeekday(year, 2, 1, 3)) return true;
      // Good Friday (2 days before Easter)
      // Easter 2026: April 5, so Good Friday is April 3
      if (year === 2026 && month === 4 && day === 3) return true;
      // Memorial Day (last Monday of May)
      let lastMonday = getNthWeekday(year, 5, 1, 4);
      if (month === 5 && day === lastMonday) {
        let d = new Date(Date.UTC(year, 4, lastMonday + 7));
        if (d.getUTCMonth() === 4) return true; // Still in May
        return day === lastMonday;
      }
      // Juneteenth
      if (month === 6 && day === 19) return true;
      // Independence Day
      if (month === 7 && day === 4) return true;
      // Labor Day (1st Monday of September)
      if (month === 9 && day === getNthWeekday(year, 9, 1, 1)) return true;
      // Thanksgiving (4th Thursday of November)
      if (month === 11 && day === getNthWeekday(year, 11, 4, 4)) return true;
      // Christmas
      if (month === 12 && day === 25) return true;
    }
    
    return false;
  }

  /* MARKETS */
  const markets = [
    // Core
    { id:"nyse", name:"US (NYSE + NASDAQ)", tz:"America/New_York", pre: 13*3600, open: 14.5*3600, close: 21*3600, after: 22*3600, localOpen: "09:30", localClose: "16:00", category:"core", core:true, abbreviation:"US", country:"United States", city:"New York", tags:["usa","nyc","nasdaq","new york","united states"] },
    { id:"lse", name:"London Stock Exchange (LSE)", tz:"Europe/London", open: 8*3600, close: 16.5*3600, localOpen: "08:00", localClose: "16:30", category:"core", core:true, abbreviation:"LSE", country:"United Kingdom", city:"London", tags:["uk","england","gb","gbp"] },
    { id:"tse", name:"Tokyo Stock Exchange (JPX)", tz:"Asia/Tokyo", open1: 0*3600, close1: 2.5*3600, open2: 3.5*3600, close2: 6*3600, localOpen1: "09:00", localClose1: "11:30", localOpen2: "12:30", localClose2: "15:00", category:"core", core:true, abbreviation:"JPX", country:"Japan", city:"Tokyo", tags:["jpx","tse","japan"] },
    { id:"hkex", name:"Hong Kong Stock Exchange (HKEX)", tz:"Asia/Hong_Kong", open1: 1*3600, close1: 4*3600, open2: 5*3600, close2: 8*3600, localOpen1: "09:30", localClose1: "12:00", localOpen2: "13:00", localClose2: "16:00", category:"core", core:true, abbreviation:"HKEX", country:"China", city:"Hong Kong", tags:["hong kong","china","hsi"] },
    { id:"sse", name:"Shanghai Stock Exchange (SSE)", tz:"Asia/Shanghai", open1: 1.5*3600, close1: 3.5*3600, open2: 5*3600, close2: 7*3600, localOpen1: "09:30", localClose1: "11:30", localOpen2: "13:00", localClose2: "15:00", category:"core", core:true, abbreviation:"SSE", country:"China", city:"Shanghai", tags:["china","shanghai"] },
    { id:"szse", name:"Shenzhen Stock Exchange (SZSE)", tz:"Asia/Shanghai", open1: 1.5*3600, close1: 3.5*3600, open2: 5*3600, close2: 7*3600, localOpen1: "09:30", localClose1: "11:30", localOpen2: "13:00", localClose2: "15:00", category:"core", core:true, abbreviation:"SZSE", country:"China", city:"Shenzhen", tags:["china","shenzhen"] },

    // Americas
    { id:"tsx", name:"Toronto Stock Exchange (TSX)", tz:"America/Toronto", open: 14.5*3600, close: 21*3600, localOpen: "09:30", localClose: "16:00", category:"americas", abbreviation:"TSX", country:"Canada", city:"Toronto", tags:["canada"] },
    { id:"tsxv", name:"TSX Venture (TSXV)", tz:"America/Toronto", open: 14.5*3600, close: 21*3600, localOpen: "09:30", localClose: "16:00", category:"americas", abbreviation:"TSXV", country:"Canada", city:"Toronto", tags:["canada","venture"] },
    { id:"b3", name:"B3 (Brazil)", tz:"America/Sao_Paulo", open: 13*3600, close: 20.917*3600, localOpen: "10:00", localClose: "17:55", category:"americas", abbreviation:"B3", country:"Brazil", city:"Sao Paulo", tags:["brazil","bovespa"] },
    { id:"bmv", name:"Bolsa Mexicana de Valores (BMV)", tz:"America/Mexico_City", useLocalTime:true, localOpen:"09:00", localClose:"15:00", category:"americas", abbreviation:"BMV", country:"Mexico", city:"Mexico City", tags:["mexico","latam"] },

    // Europe
    { id:"euronext", name:"Euronext", tz:"Europe/Paris", useLocalTime:true, localOpen:"09:00", localClose:"17:30", category:"europe", abbreviation:"ENX", country:"Eurozone", city:"Paris", tags:["france","amsterdam","brussels","lisbon","oslo","dublin","milan"] },
    { id:"xetra", name:"Deutsche Börse (Xetra)", tz:"Europe/Berlin", open: 8*3600, close: 16.5*3600, localOpen: "09:00", localClose: "17:30", category:"europe", abbreviation:"XETRA", country:"Germany", city:"Frankfurt", tags:["germany","deutsche","frankfurt"] },
    { id:"six", name:"SIX Swiss Exchange", tz:"Europe/Zurich", useLocalTime:true, localOpen:"09:00", localClose:"17:20", category:"europe", abbreviation:"SIX", country:"Switzerland", city:"Zurich", tags:["switzerland","zurich"] },
    { id:"borsa", name:"Borsa Italiana", tz:"Europe/Rome", useLocalTime:true, localOpen:"09:00", localClose:"17:30", category:"europe", abbreviation:"Borsa", country:"Italy", city:"Milan", tags:["italy","milan"] },
    { id:"bme", name:"Madrid (BME)", tz:"Europe/Madrid", useLocalTime:true, localOpen:"09:00", localClose:"17:30", category:"europe", abbreviation:"BME", country:"Spain", city:"Madrid", tags:["spain"] },
    { id:"omx", name:"OMX Nordic", tz:"Europe/Stockholm", useLocalTime:true, localOpen:"09:00", localClose:"17:30", category:"europe", abbreviation:"OMX", country:"Nordics", city:"Stockholm", tags:["sweden","denmark","finland","nordic","helsinki","copenhagen","iceland"] },

    // Asia-Pacific
    { id:"asx", name:"ASX (Australia)", tz:"Australia/Sydney", open: 23.983*3600, close: 5*3600, localOpen: "09:59", localClose: "16:00", category:"asia-pacific", abbreviation:"ASX", country:"Australia", city:"Sydney", tags:["australia","sydney"] },
    { id:"nse", name:"NSE (India)", tz:"Asia/Kolkata", open: 3.75*3600, close: 10*3600, localOpen: "09:15", localClose: "15:30", category:"asia-pacific", abbreviation:"NSE", country:"India", city:"Mumbai", tags:["india","national stock exchange"] },
    { id:"bse", name:"BSE (India)", tz:"Asia/Kolkata", useLocalTime:true, localOpen:"09:15", localClose:"15:30", category:"asia-pacific", abbreviation:"BSE", country:"India", city:"Mumbai", tags:["india","bombay"] },
    { id:"krx", name:"KRX (Korea)", tz:"Asia/Seoul", useLocalTime:true, localOpen:"09:00", localClose:"15:30", category:"asia-pacific", abbreviation:"KRX", country:"South Korea", city:"Seoul", tags:["korea","kospi"] },
    { id:"twse", name:"TWSE (Taiwan)", tz:"Asia/Taipei", useLocalTime:true, localOpen:"09:00", localClose:"13:30", category:"asia-pacific", abbreviation:"TWSE", country:"Taiwan", city:"Taipei", tags:["taiwan"] },
    { id:"sgx", name:"Singapore (SGX)", tz:"Asia/Singapore", open: 1*3600, close: 9*3600, localOpen: "09:00", localClose: "17:00", category:"asia-pacific", abbreviation:"SGX", country:"Singapore", city:"Singapore", tags:["singapore"] },
    { id:"bursa", name:"Bursa Malaysia", tz:"Asia/Kuala_Lumpur", useLocalTime:true, localOpen1:"09:00", localClose1:"12:30", localOpen2:"14:30", localClose2:"17:00", category:"asia-pacific", abbreviation:"BURSA", country:"Malaysia", city:"Kuala Lumpur", tags:["malaysia","kl"] },
    { id:"idx", name:"IDX (Indonesia)", tz:"Asia/Jakarta", useLocalTime:true, localOpen1:"09:00", localClose1:"11:30", localOpen2:"13:30", localClose2:"15:00", category:"asia-pacific", abbreviation:"IDX", country:"Indonesia", city:"Jakarta", tags:["indonesia","jakarta"] },

    // Middle East & Africa
    { id:"tadawul", name:"Tadawul (Saudi Arabia)", tz:"Asia/Riyadh", useLocalTime:true, localOpen:"10:00", localClose:"15:10", category:"mea", abbreviation:"TASI", country:"Saudi Arabia", city:"Riyadh", tags:["saudi"] },
    { id:"dfm", name:"DFM (Dubai)", tz:"Asia/Dubai", useLocalTime:true, localOpen:"10:00", localClose:"14:45", category:"mea", abbreviation:"DFM", country:"UAE", city:"Dubai", tags:["dubai","uae"] },
    { id:"adx", name:"ADX (Abu Dhabi)", tz:"Asia/Dubai", useLocalTime:true, localOpen:"10:00", localClose:"14:44", category:"mea", abbreviation:"ADX", country:"UAE", city:"Abu Dhabi", tags:["uae","abu dhabi"] },
    { id:"qse", name:"QSE (Qatar)", tz:"Asia/Riyadh", useLocalTime:true, localOpen:"09:30", localClose:"13:00", category:"mea", abbreviation:"QSE", country:"Qatar", city:"Doha", tags:["qatar"] },
    { id:"jse", name:"JSE (South Africa)", tz:"Africa/Johannesburg", useLocalTime:true, localOpen:"09:00", localClose:"17:00", category:"mea", abbreviation:"JSE", country:"South Africa", city:"Johannesburg", tags:["south africa","johannesburg"] },

    // Futures & Commodities
    { id:"cme", name:"CME Globex", tz:"UTC", open: 23*3600, close: 22*3600, category:"futures", abbreviation:"CME", country:"United States", city:"Chicago", tags:["futures","oil","nymex","comex","cme","globex"] },
    { id:"iceus", name:"ICE Futures U.S.", tz:"UTC", open: 23*3600, close: 22*3600, category:"futures", abbreviation:"ICE US", country:"United States", city:"New York", tags:["ice","brent","cotton","us"] },
    { id:"iceeurope", name:"ICE Futures Europe", tz:"UTC", open: 23*3600, close: 22*3600, category:"futures", abbreviation:"ICE Europe", country:"United Kingdom", city:"London", tags:["ice","brent","gas","europe"] },
    { id:"eurex", name:"Eurex", tz:"UTC", open: 7*3600, close: 21*3600, category:"futures", abbreviation:"Eurex", country:"Germany", city:"Frankfurt", tags:["derivatives","eurex"] },

    // Crypto
  ];

  /* TIMEZONE TOGGLE */
  let showLocalMarketTime = false;
  const tzToggle = document.getElementById("tzToggle");
  tzToggle.addEventListener("click", () => {
    showLocalMarketTime = !showLocalMarketTime;
    tzToggle.textContent = showLocalMarketTime ? "Show Your Timezone" : "Show Market Local Times";
    updateMarkets();
  });

  /* UTC TOGGLE */
  let showUTC = false;
  const utcToggle = document.getElementById("utcToggle");
  utcToggle.addEventListener("click", () => {
    showUTC = !showUTC;
    utcToggle.textContent = showUTC ? "Show Your Time" : "Show UTC";
    updateTop();
  });

  /* FILTER TOGGLE */
  let filterMode = "none"; // "none", "open", "closed"
  const filterToggle = document.getElementById("filterToggle");
  filterToggle.addEventListener("click", () => {
    if (filterMode === "none") {
      filterMode = "open";
      filterToggle.textContent = "Show Closed First";
    } else if (filterMode === "open") {
      filterMode = "closed";
      filterToggle.textContent = "Show All";
    } else {
      filterMode = "none";
      filterToggle.textContent = "Show Open First";
    }
    sortMarketsByStatus();
  });

  /* FAVORITES SYSTEM */
  let favorites = new Set();
  let showFavoritesOnly = false;

  function loadFavorites() {
    try {
      const saved = localStorage.getItem("marketFavorites");
      if (saved) {
        favorites = new Set(JSON.parse(saved));
      }
    } catch (e) {
      favorites = new Set();
    }
  }

  function saveFavorites() {
    localStorage.setItem("marketFavorites", JSON.stringify([...favorites]));
  }

  function toggleFavorite(marketId) {
    if (favorites.has(marketId)) {
      favorites.delete(marketId);
    } else {
      favorites.add(marketId);
    }
    saveFavorites();
    updateFavoriteButtons();
    refreshFavoritesSection();
    applySearchAndFavoriteFilter();
  }

  function updateFavoriteButtons() {
    document.querySelectorAll(".favorite-btn").forEach(btn => {
      const marketId = btn.dataset.id;
      if (favorites.has(marketId)) {
        btn.classList.add("favorited");
        btn.textContent = "★";
      } else {
        btn.classList.remove("favorited");
        btn.textContent = "☆";
      }
    });
  }

  function applyFavoriteFilter() {
    applySearchAndFavoriteFilter();
  }

  const favoriteToggle = document.getElementById("favoriteToggle");
  favoriteToggle.addEventListener("click", () => {
    showFavoritesOnly = !showFavoritesOnly;
    favoriteToggle.textContent = showFavoritesOnly ? "Show All Markets" : "Show Favorites Only";
    applyFavoriteFilter();
  });

  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("favorite-btn")) {
      e.stopPropagation();
      e.preventDefault();
      const marketId = e.target.dataset.id;
      toggleFavorite(marketId);
    }
  });

  function matchesSearch(term, card) {
    if (!term) return true;
    const haystack = [
      card.dataset.name || "",
      card.dataset.abbreviation || "",
      card.dataset.country || "",
      card.dataset.city || "",
      card.dataset.tags || ""
    ].join(" ");
    return haystack.includes(term);
  }

  function applySearchAndFavoriteFilter() {
    const term = (document.getElementById("searchBar").value || "").trim().toLowerCase();
    document.querySelectorAll(".market").forEach(card => {
      const id = card.id.replace("market-", "");
      const visible = matchesSearch(term, card) && (!showFavoritesOnly || favorites.has(id));
      card.style.display = visible ? "" : "none";
    });
    // Hide category blocks with no visible cards (except favorites when hidden)
    categoryContentMap.forEach(({ block, content, cfg }) => {
      if (cfg.id === "favorites") return; // handled separately
      const hasVisible = [...content.querySelectorAll(".market")].some(card => card.style.display !== "none");
      block.style.display = hasVisible ? "block" : "none";
    });
    // Apply to favorite clones
    const favSection = categoryContentMap.get("favorites");
    if (favSection) {
      const hasFavs = favorites.size > 0;
      favSection.block.style.display = hasFavs ? "block" : "none";
      [...favSection.content.querySelectorAll(".market")].forEach(card => {
        const sourceId = (card.id || "").replace("fav-", "");
        const visible = matchesSearch(term, card) && (!showFavoritesOnly || favorites.has(sourceId));
        card.style.display = visible ? "" : "none";
      });
    }
  }

  document.getElementById("searchBar").addEventListener("input", applySearchAndFavoriteFilter);

  function sortMarketsByStatus() {
    if (filterMode === "none") return;
    categoryContentMap.forEach(({ content, cfg }) => {
      if (cfg.id === "favorites") return;
      const marketEls = [...content.querySelectorAll(".market")];
      marketEls.sort((a, b) => {
        const aOpen = a.classList.contains("open");
        const bOpen = b.classList.contains("open");
        if (filterMode === "open") {
          return bOpen - aOpen; // open first
        } else {
          return aOpen - bOpen; // closed first
        }
      });
      marketEls.forEach(el => content.appendChild(el));
    });
  }

  /* ALERT SYSTEM */
  let alertSettings = {};
  let triggeredAlerts = new Set();

  function loadAlertSettings() {
    try {
      const saved = localStorage.getItem("alertSettings");
      if (saved) {
        alertSettings = JSON.parse(saved);
      } else {
        // Initialize default settings
        markets.forEach(m => {
          alertSettings[m.id] = {
            openEnabled: false,
            openValue: 5,
            openUnit: 'minutes',
            closeEnabled: false,
            closeValue: 5,
            closeUnit: 'minutes'
          };
        });
      }
    } catch (e) {
      alertSettings = {};
    }
  }

  function saveAlertSettings() {
    localStorage.setItem("alertSettings", JSON.stringify(alertSettings));
  }

  function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
  }

  function showNotification(title, body) {
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(title, { body, icon: "Market4.png" });
    } else {
      alert(title + "\n" + body);
    }
  }

  function buildAlertSettings() {
    const container = document.getElementById("alertSettingsContainer");
    container.innerHTML = "";
    
    markets.forEach(m => {
      const settings = alertSettings[m.id] || {
        openEnabled: false,
        openValue: 5,
        openUnit: 'minutes',
        closeEnabled: false,
        closeValue: 5,
        closeUnit: 'minutes'
      };

      const div = document.createElement("div");
      div.className = "alert-market";
      div.innerHTML = `
        <h3>${m.name}</h3>
        <div class="alert-controls">
          <input type="checkbox" id="${m.id}-open-enabled" ${settings.openEnabled ? 'checked' : ''}>
          <label for="${m.id}-open-enabled">Alert before open:</label>
          <input type="number" id="${m.id}-open-value" value="${settings.openValue}" min="1" max="1440">
          <select id="${m.id}-open-unit">
            <option value="minutes" ${settings.openUnit === 'minutes' ? 'selected' : ''}>Minutes</option>
            <option value="hours" ${settings.openUnit === 'hours' ? 'selected' : ''}>Hours</option>
          </select>
        </div>
        <div class="alert-controls">
          <input type="checkbox" id="${m.id}-close-enabled" ${settings.closeEnabled ? 'checked' : ''}>
          <label for="${m.id}-close-enabled">Alert before close:</label>
          <input type="number" id="${m.id}-close-value" value="${settings.closeValue}" min="1" max="1440">
          <select id="${m.id}-close-unit">
            <option value="minutes" ${settings.closeUnit === 'minutes' ? 'selected' : ''}>Minutes</option>
            <option value="hours" ${settings.closeUnit === 'hours' ? 'selected' : ''}>Hours</option>
          </select>
        </div>
      `;
      container.appendChild(div);

      // Add event listeners
      const openEnabled = div.querySelector(`#${m.id}-open-enabled`);
      const openValue = div.querySelector(`#${m.id}-open-value`);
      const openUnit = div.querySelector(`#${m.id}-open-unit`);
      const closeEnabled = div.querySelector(`#${m.id}-close-enabled`);
      const closeValue = div.querySelector(`#${m.id}-close-value`);
      const closeUnit = div.querySelector(`#${m.id}-close-unit`);

      [openEnabled, openValue, openUnit, closeEnabled, closeValue, closeUnit].forEach(el => {
        el.addEventListener('change', () => {
          alertSettings[m.id] = {
            openEnabled: openEnabled.checked,
            openValue: parseInt(openValue.value),
            openUnit: openUnit.value,
            closeEnabled: closeEnabled.checked,
            closeValue: parseInt(closeValue.value),
            closeUnit: closeUnit.value
          };
          saveAlertSettings();
        });
      });
    });
  }

  const alertToggle = document.getElementById("alertToggle");
  const alertModal = document.getElementById("alertModal");
  const closeAlertModal = document.getElementById("closeAlertModal");

  alertToggle.addEventListener("click", () => {
    requestNotificationPermission();
    buildAlertSettings();
    alertModal.style.display = "flex";
  });

  closeAlertModal.addEventListener("click", () => {
    alertModal.style.display = "none";
  });

  alertModal.addEventListener("click", (e) => {
    if (e.target === alertModal) {
      alertModal.style.display = "none";
    }
  });

  function checkAlerts(m, label, secs) {
    const settings = alertSettings[m.id];
    if (!settings) return;

    const day = new Date().getUTCDay();
    const isWeekend = (day === 0 || day === 6);
    if (isWeekend) return; // Don't trigger alerts on weekends

    // Check open alerts
    if (settings.openEnabled && label === "Opens in") {
      const targetSecs = settings.openUnit === 'hours' ? settings.openValue * 3600 : settings.openValue * 60;
      const alertKey = `${m.id}-open-${targetSecs}`;
      
      if (secs <= targetSecs && secs > targetSecs - 60 && !triggeredAlerts.has(alertKey)) {
        triggeredAlerts.add(alertKey);
        const timeStr = settings.openUnit === 'hours' ? `${settings.openValue} hour${settings.openValue > 1 ? 's' : ''}` : `${settings.openValue} minute${settings.openValue > 1 ? 's' : ''}`;
        showNotification(`${m.name} Opening Soon`, `Market opens in ${timeStr}`);
        // Clear this alert after 2 minutes to allow re-triggering if needed
        setTimeout(() => triggeredAlerts.delete(alertKey), 120000);
      }
    }

    // Check close alerts
    if (settings.closeEnabled && label === "Closes in") {
      const targetSecs = settings.closeUnit === 'hours' ? settings.closeValue * 3600 : settings.closeValue * 60;
      const alertKey = `${m.id}-close-${targetSecs}`;
      
      if (secs <= targetSecs && secs > targetSecs - 60 && !triggeredAlerts.has(alertKey)) {
        triggeredAlerts.add(alertKey);
        const timeStr = settings.closeUnit === 'hours' ? `${settings.closeValue} hour${settings.closeValue > 1 ? 's' : ''}` : `${settings.closeValue} minute${settings.closeValue > 1 ? 's' : ''}`;
        showNotification(`${m.name} Closing Soon`, `Market closes in ${timeStr}`);
        setTimeout(() => triggeredAlerts.delete(alertKey), 120000);
      }
    }
  }

  loadAlertSettings();

  /* STAGE LOGIC */
  function getStage(now, m) {
    if (m.scheduleType === "alwaysOpen") return "Open 24/7";
    if (m.scheduleType === "comingSoon") return "Coming soon";
    if (m.pre !== undefined) {
      if (inRange(now, m.pre, m.open)) return "Pre‑Market";
      if (inRange(now, m.open, m.close)) return "Regular Hours";
      if (inRange(now, m.close, m.after)) return "After Hours";
      return "Overnight";
    }
    if (m.open1 !== undefined) {
      if (inRange(now, m.open1, m.close1)) return "Morning Session";
      if (inRange(now, m.close1, m.open2)) return "Lunch Break";
      if (inRange(now, m.open2, m.close2)) return "Afternoon Session";
      return "Overnight";
    }
    if (inRange(now, m.open, m.close)) return "Regular Hours";
    return "Overnight";
  }

  /* TIMELINE */
  function drawSeg(a,b,cls){
    if(b>a){
      return `<div class="seg ${cls}" style="left:${pct(a)}%;width:${pct(b-a)}%"></div>`;
    }else{
      return `<div class="seg ${cls}" style="left:${pct(a)}%;width:${pct(86400-a)}%"></div>
              <div class="seg ${cls}" style="left:0;width:${pct(b)}%"></div>`;
    }
  }
  function drawTimeline(m) {
    if (m.scheduleType === "alwaysOpen") {
      return `<div class="seg regular" style="left:0;width:100%"></div>`;
    }
    if (m.scheduleType === "comingSoon") {
      return `<div class="seg overnight" style="left:0;width:100%;opacity:0.35"></div>`;
    }
    let html = "";
    if (m.pre !== undefined) {
      html += drawSeg(m.pre, m.open, "pre");
      html += drawSeg(m.open, m.close, "regular");
      html += drawSeg(m.close, m.after, "after");
      html += drawSeg(m.after, m.pre, "overnight");
      return html;
    }
    if (m.open1 !== undefined) {
      html += drawSeg(m.open1, m.close1, "regular");
      html += drawSeg(m.close1, m.open2, "overnight");
      html += drawSeg(m.open2, m.close2, "regular");
      html += drawSeg(m.close2, m.open1, "overnight");
      return html;
    }
    html += drawSeg(m.open, m.close, "regular");
    html += drawSeg(m.close, m.open, "overnight");
    return html;
  }

  /* COUNTDOWN */
  function nextEvent(now, m) {
    const add = t => (t - now + 86400) % 86400;
    if (m.scheduleType === "alwaysOpen") return ["Open", 0];
    if (m.scheduleType === "comingSoon") return ["Coming soon", 0];
    if (m.pre !== undefined) {
      if (inRange(now, m.pre, m.open)) return ["Opens in", add(m.open)];
      if (inRange(now, m.open, m.close)) return ["Closes in", add(m.close)];
      if (inRange(now, m.close, m.after)) return ["After‑hours ends in", add(m.after)];
      return m.id === "nyse" ? ["Opens in", add(m.open)] : ["Opens in", add(m.pre)];
    }
    if (m.open1 !== undefined) {
      if (inRange(now, m.open1, m.close1)) return ["Closes in", add(m.close1)];
      if (inRange(now, m.close1, m.open2)) return ["Reopens in", add(m.open2)];
      if (inRange(now, m.open2, m.close2)) return ["Closes in", add(m.close2)];
      return ["Opens in", add(m.open1)];
    }
    if (inRange(now, m.open, m.close)) return ["Closes in", add(m.close)];
    return ["Opens in", add(m.open)];
  }

  /* LAYOUT + RENDERING */
  const categoryOrder = [
    { id: "favorites", title: "My Markets", collapsible: false, optional: true },
    { id: "core", title: "Core Markets", collapsible: false },
    { id: "americas", title: "Americas", collapsible: true, defaultCollapsed: true },
    { id: "europe", title: "Europe", collapsible: true, defaultCollapsed: true },
    { id: "asia-pacific", title: "Asia-Pacific", collapsible: true, defaultCollapsed: true },
    { id: "mea", title: "Middle East & Africa", collapsible: true, defaultCollapsed: true },
    { id: "futures", title: "Futures & Commodities", collapsible: true, defaultCollapsed: true },
  ];

  function createMarketCard(m) {
    const wrapper = document.createElement("div");
    wrapper.className = "market closed";
    wrapper.id = `market-${m.id}`;
    wrapper.dataset.category = m.category;
    wrapper.dataset.name = m.name.toLowerCase();
    wrapper.dataset.abbreviation = (m.abbreviation || "").toLowerCase();
    wrapper.dataset.country = (m.country || "").toLowerCase();
    wrapper.dataset.city = (m.city || "").toLowerCase();
    wrapper.dataset.tags = (m.tags || []).join(" ").toLowerCase();

    wrapper.innerHTML = `
      <button class="favorite-btn" data-id="${m.id}" title="Favorite">☆</button>
      <div class="market-header">
        <strong class="market-name">${m.name}</strong>
        <span class="market-status">CLOSED</span>
        <span class="market-countdown-label">Opens in</span>
        <span class="market-countdown">--</span>
      </div>
      <em class="market-stage">Stage: --</em>
      <div class="timeline">
        ${drawTimeline(m)}
        <div class="now"></div>
      </div>
      <div class="reorder-arrows">
        <button class="arrow-up" data-id="${m.id}" title="Move up">▲</button>
        <button class="arrow-down" data-id="${m.id}" title="Move down">▼</button>
      </div>
    `;
    return wrapper;
  }

  function buildCategoryBlock(cfg) {
    const block = document.createElement("div");
    block.className = "category-block";
    block.dataset.category = cfg.id;
    const header = document.createElement("div");
    header.className = "category-header";
    const title = document.createElement("div");
    title.className = "category-title";
    title.textContent = cfg.title;
    header.appendChild(title);
    if (cfg.collapsible) {
      const toggleBtn = document.createElement("button");
      toggleBtn.className = "category-toggle";
      if (cfg.defaultCollapsed) {
        block.classList.add("category-collapsed");
      }
      toggleBtn.textContent = block.classList.contains("category-collapsed") ? "Show" : "Hide";
      toggleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        block.classList.toggle("category-collapsed");
        toggleBtn.textContent = block.classList.contains("category-collapsed") ? "Show" : "Hide";
      });
      header.appendChild(toggleBtn);
    }
    block.appendChild(header);

    const content = document.createElement("div");
    content.className = "category-content";
    block.appendChild(content);

    if (cfg.id === "favorites") {
      const empty = document.createElement("div");
      empty.id = "myMarketsEmpty";
      empty.textContent = "Star markets to pin them here.";
      block.appendChild(empty);
    }

    return { block, content };
  }

  const categoriesContainer = document.getElementById("categories");
  const categoryContentMap = new Map();

  function renderLayout() {
    // recompute local-time-derived UTC schedules before first render
    markets.forEach(applyLocalTimes);

    categoriesContainer.innerHTML = "";
    categoryContentMap.clear();
    categoryOrder.forEach(cfg => {
      const { block, content } = buildCategoryBlock(cfg);
      if (cfg.optional) {
        block.style.display = "none"; // only shown when favorites exist
      }
      categoriesContainer.appendChild(block);
      categoryContentMap.set(cfg.id, { block, content, cfg });
    });

    markets.forEach(m => {
      const card = createMarketCard(m);
      const entry = categoryContentMap.get(m.category || "others");
      if (entry) {
        entry.content.appendChild(card);
      }
    });
  }

  function refreshFavoritesSection() {
    const favSection = categoryContentMap.get("favorites");
    if (!favSection) return;
    const { block, content } = favSection;
    content.innerHTML = "";
    const hasFavs = favorites.size > 0;
    block.style.display = hasFavs ? "block" : "none";
    const empty = block.querySelector("#myMarketsEmpty");
    if (empty) empty.style.display = hasFavs ? "none" : "block";
    if (!hasFavs) return;
    favorites.forEach(id => {
      const mainCard = document.getElementById(`market-${id}`);
      if (mainCard) {
        const clone = mainCard.cloneNode(true);
        clone.id = `fav-${id}`;
        clone.classList.add("favorite-clone");
        clone.querySelectorAll(".reorder-arrows").forEach(el => el.remove());
        clone.querySelectorAll(".favorite-btn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            e.preventDefault();
            toggleFavorite(id);
          });
        });
        content.appendChild(clone);
      }
    });
  }

  function syncFavoriteClones(marketId, data) {
    document.querySelectorAll(`#fav-${marketId}`).forEach(clone => {
      clone.classList.toggle("open", data.isOpen);
      clone.classList.toggle("closed", !data.isOpen);
      const statusEl = clone.querySelector(".market-status");
      const countdownLabelEl = clone.querySelector(".market-countdown-label");
      const countdownEl = clone.querySelector(".market-countdown");
      const stageEl = clone.querySelector(".market-stage");
      const nowLine = clone.querySelector(".now");
      if (statusEl) statusEl.textContent = data.statusText;
      if (countdownLabelEl) countdownLabelEl.textContent = data.labelText;
      if (countdownEl) countdownEl.textContent = data.countdownText;
      if (stageEl) stageEl.textContent = data.stageText;
      if (nowLine) nowLine.style.left = data.nowPct + "%";
    });
  }

       /* TRELLO‑STYLE DRAG & DROP with HOLD-TO-DRAG on touch */
  let draggedEl = null;
  let placeholder = null;
  let offsetX = 0;
  let offsetY = 0;
  let holdTimer = null;
  let isDragging = false;
  let lastX = 0;
  let lastY = 0;
  let moveListenerAdded = false;
  let activePointerId = null;
  let prevOverflow = "";

  function enableDragAndDrop() {
    const isDesktop = window.matchMedia("(min-width: 901px)").matches;
    if (!isDesktop) return; // Skip drag-and-drop on mobile
    
    document.querySelectorAll(".market").forEach(card => {
      if (card.classList.contains("favorite-clone")) return;
      card.style.touchAction = "pan-y";
      card.style.cursor = "grab";
      card.addEventListener("pointerdown", onPointerDown);
    });
  }

  /* ARROW-BASED REORDERING FOR MOBILE */
  function enableArrowReordering() {
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("arrow-up")) {
        const marketId = e.target.dataset.id;
        const market = document.getElementById(`market-${marketId}`);
        const prev = market.previousElementSibling;
        if (prev) {
          market.parentNode.insertBefore(market, prev);
          saveOrder();
        }
      } else if (e.target.classList.contains("arrow-down")) {
        const marketId = e.target.dataset.id;
        const market = document.getElementById(`market-${marketId}`);
        const next = market.nextElementSibling;
        if (next) {
          market.parentNode.insertBefore(next, market);
          saveOrder();
        }
      }
    });
  }

  function onPointerDown(e) {
    if (isDragging) return; // ignore if already dragging
    // Don't start drag if clicking on favorite button or arrow buttons
    if (e.target.classList.contains("favorite-btn") || 
        e.target.classList.contains("arrow-up") || 
        e.target.classList.contains("arrow-down")) {
      return;
    }
    const card = e.currentTarget;
    lastX = e.clientX;
    lastY = e.clientY;
    activePointerId = e.pointerId;
    const isTouch = e.pointerType === "touch";
    const holdDelay = isTouch ? 450 : 0;

    clearTimeout(holdTimer);
    if (holdDelay === 0) {
      // Desktop: start drag immediately
      startDrag(card);
    } else {
      // Touch: wait for hold
      holdTimer = setTimeout(() => startDrag(card), holdDelay);
    }

    // Add move/up listeners only once
    if (!moveListenerAdded) {
      moveListenerAdded = true;
      document.addEventListener("pointermove", onPointerMove, { passive: false });
      document.addEventListener("pointerup", onPointerUp);
      document.addEventListener("pointercancel", onPointerUp);
    }
  }

  function startDrag(card) {
    if (isDragging) return;
    draggedEl = card;
    isDragging = true;
    draggedEl.classList.add("dragging");
    draggedEl.style.cursor = "grabbing";
    if (activePointerId !== null && draggedEl.setPointerCapture) {
      draggedEl.setPointerCapture(activePointerId);
    }

    const rect = draggedEl.getBoundingClientRect();
    offsetX = lastX - rect.left;
    offsetY = lastY - rect.top;

    placeholder = document.createElement("div");
    placeholder.className = "market placeholder";
    placeholder.style.height = rect.height + "px";
    draggedEl.parentNode.insertBefore(placeholder, draggedEl.nextSibling);

    draggedEl.style.position = "fixed";
    draggedEl.style.zIndex = 10000;
    draggedEl.style.width = rect.width + "px";
    draggedEl.style.pointerEvents = "none";
    document.body.style.userSelect = "none";
    prevOverflow = document.body.style.overflow;
    document.body.style.overflow = "hidden";

    moveDragged(lastX, lastY);
  }

  function moveDragged(x, y) {
    if (!draggedEl) return;
    draggedEl.style.left = (x - offsetX) + "px";
    draggedEl.style.top = (y - offsetY) + "px";
  }

  function onPointerMove(e) {
    if (activePointerId !== null && e.pointerId !== activePointerId) return;
    if (holdTimer !== null) {
      // Still waiting for hold to trigger—check if user moved too far
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      if (Math.sqrt(dx * dx + dy * dy) > 8) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }
      return;
    }

    if (!isDragging || !draggedEl) return;

    // Prevent text selection during drag
    e.preventDefault();

    lastX = e.clientX;
    lastY = e.clientY;
    moveDragged(lastX, lastY);

    draggedEl.style.visibility = "hidden";
    const elBelow = document.elementFromPoint(e.clientX, e.clientY);
    draggedEl.style.visibility = "";

    const target = elBelow ? elBelow.closest(".market") : null;

    if (target && !target.classList.contains("dragging") && target.parentNode) {
      const rect = target.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      if (e.clientY < midY) {
        target.parentNode.insertBefore(placeholder, target);
      } else {
        target.parentNode.insertBefore(placeholder, target.nextSibling);
      }
    } else {
      const container = document.getElementById("markets");
      if (container && container !== placeholder.parentNode) {
        container.appendChild(placeholder);
      } else if (!placeholder.parentNode) {
        container.appendChild(placeholder);
      }
    }
  }

  function onPointerUp() {
    clearTimeout(holdTimer);
    holdTimer = null;

    if (!isDragging || !draggedEl) {
      moveListenerAdded = false;
      document.removeEventListener("pointermove", onPointerMove);
      document.removeEventListener("pointerup", onPointerUp);
      document.removeEventListener("pointercancel", onPointerUp);
      return;
    }

    draggedEl.classList.remove("dragging");
    draggedEl.style.cursor = "grab";
    draggedEl.style.position = "";
    draggedEl.style.left = "";
    draggedEl.style.top = "";
    draggedEl.style.width = "";
    draggedEl.style.zIndex = "";
    draggedEl.style.pointerEvents = "";
    document.body.style.userSelect = "";
    document.body.style.overflow = prevOverflow;
    prevOverflow = "";
    if (draggedEl && activePointerId !== null && draggedEl.releasePointerCapture) {
      try { draggedEl.releasePointerCapture(activePointerId); } catch(e) {}
    }

    if (placeholder && placeholder.parentNode) {
      placeholder.parentNode.insertBefore(draggedEl, placeholder);
      placeholder.remove();
    }

    placeholder = null;
    saveOrder();
    draggedEl = null;
    isDragging = false;
    moveListenerAdded = false;
    activePointerId = null;
    document.removeEventListener("pointermove", onPointerMove);
    document.removeEventListener("pointerup", onPointerUp);
    document.removeEventListener("pointercancel", onPointerUp);
  }
  function saveOrder() {
    const ids = [...document.querySelectorAll(".market")]
      .filter(el => !el.classList.contains("favorite-clone"))
      .map(el => el.id);
    localStorage.setItem("marketOrder", JSON.stringify(ids));
  }

  function loadOrder() {
    try {
      const saved = JSON.parse(localStorage.getItem("marketOrder") || "[]");
      if (!saved.length) return;
      saved.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.parentNode) {
          el.parentNode.appendChild(el);
        }
      });
    } catch (e) {}
  }

  document.getElementById("resetOrderBtn").addEventListener("click", () => {
    localStorage.removeItem("marketOrder");
    renderLayout();
    enableDragAndDrop();
    updateFavoriteButtons();
    refreshFavoritesSection();
    applySearchAndFavoriteFilter();
    updateMarkets();
  });

  /* FEEDBACK BUTTONS */
  document.getElementById("reportHoursBtn").addEventListener("click", () => {
    const subject = "Market Clock - Report Incorrect Market Hours";
    const body = "Please describe which market has incorrect hours and what the correct hours should be:\n\n";
    window.location.href = `mailto:contact@marketclock.co.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  });

  document.getElementById("feedbackBtn").addEventListener("click", () => {
    const subject = "Market Clock - Feedback";
    const body = "Please share your feedback:\n\n";
    window.location.href = `mailto:contact@marketclock.co.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  });

  /* UPDATE LOOP */
  function updateMarkets(){
    const now = utcSec();
    const today = new Date();
    const day = today.getUTCDay();
    const isWeekend = (day === 0 || day === 6);
    const openList = document.getElementById("openMarketsList");
    openList.innerHTML = "";
    const openingSoonList = document.getElementById("openingSoonList");
openingSoonList.innerHTML = "";
    const closingSoonList = document.getElementById("closingSoonList");
    closingSoonList.innerHTML = "";
    markets.forEach(m => {
      applyLocalTimes(m);
      const el = document.getElementById(`market-${m.id}`);
      const statusEl = el.querySelector(".market-status");
      const countdownEl = el.querySelector(".market-countdown");
      const countdownLabelEl = el.querySelector(".market-countdown-label");
      const stageEl = el.querySelector(".market-stage");
      const nowLine = el.querySelector(".now");
      
      let stage, label, secs;
      
      const isHoliday = isMarketHoliday(today, m.id);

      if (m.scheduleType === "comingSoon") {
        stage = "Coming soon";
        label = "Coming soon";
        secs = 0;
      } else if (m.scheduleType === "alwaysOpen") {
        stage = "Open 24/7";
        label = "Open";
        secs = 0;
      } else if (isWeekend || isHoliday) {
        // On weekends or holidays, show as closed and calculate time until next trading day
        stage = isHoliday ? "Closed (Holiday)" : "Closed (Weekend)";
        let nextTradingDay = new Date(today);
        nextTradingDay.setUTCDate(nextTradingDay.getUTCDate() + 1);
        
        // Skip to next trading day (skip weekends and holidays)
        while (nextTradingDay.getUTCDay() === 0 || nextTradingDay.getUTCDay() === 6 || isMarketHoliday(nextTradingDay, m.id)) {
          nextTradingDay.setUTCDate(nextTradingDay.getUTCDate() + 1);
        }
        
        const openTime = m.open1 !== undefined ? m.open1 : m.open;
        const secsToOpen = (Math.ceil((nextTradingDay.getTime() - today.getTime()) / 86400000) * 86400) - now + openTime;
        label = "Opens in";
        secs = secsToOpen;
      } else {
        stage = getStage(now, m);
        [label, secs] = nextEvent(now, m);
      }
      
      if (label === "Opens in" && secs > 0 && secs <= 3600 && !isWeekend && !isHoliday) {
        const soonLi = document.createElement("li");
        soonLi.textContent = el.querySelector(".market-name").textContent + " — " + format(secs);
        openingSoonList.appendChild(soonLi);
      }
      if (label === "Closes in" && secs > 0 && secs <= 3600 && !isWeekend && !isHoliday) {
        const closingLi = document.createElement("li");
        closingLi.textContent = el.querySelector(".market-name").textContent + " — " + format(secs);
        closingSoonList.appendChild(closingLi);
      }
      let isOpen = false;
      if (m.scheduleType === "alwaysOpen") {
        isOpen = true;
      } else if (m.scheduleType === "comingSoon") {
        isOpen = false;
      } else if (!isWeekend && !isHoliday) {
        if (m.pre !== undefined) {
          isOpen = inRange(now, m.open, m.close);
        } else if (m.open1 !== undefined) {
          isOpen = inRange(now, m.open1, m.close1) || inRange(now, m.open2, m.close2);
        } else {
          isOpen = inRange(now, m.open, m.close);
        }
      }
      el.classList.toggle("open", isOpen);
      el.classList.toggle("closed", !isOpen);
      statusEl.textContent = m.scheduleType === "comingSoon" ? "COMING SOON" : (isOpen ? "OPEN" : "CLOSED");
      countdownLabelEl.textContent = label;
      countdownEl.textContent = label === "Coming soon" ? "--" : format(secs);

      // Check alerts
      checkAlerts(m, label, secs);

      if (showLocalMarketTime && m.tz) {
        if (m.open1 !== undefined) {
          stageEl.textContent = `Stage: ${stage} (Local: ${m.localOpen1}–${m.localClose1}, ${m.localOpen2}–${m.localClose2})`;
        } else if (m.localOpen !== undefined) {
          stageEl.textContent = `Stage: ${stage} (Local: ${m.localOpen}–${m.localClose})`;
        } else {
          stageEl.textContent = `Stage: ${stage}`;
        }
      } else {
        stageEl.textContent = "Stage: " + stage;
      }

      nowLine.style.left = pct(now) + "%";
      if (isOpen) {
        const li = document.createElement("li");
        const name = el.querySelector(".market-name").textContent;
        li.innerHTML = name + ' <span class="open-dot" aria-hidden="true">🟢</span>';
        openList.appendChild(li);
      }

      syncFavoriteClones(m.id, {
        isOpen,
        statusText: m.scheduleType === "comingSoon" ? "COMING SOON" : (isOpen ? "OPEN" : "CLOSED"),
        labelText: label,
        countdownText: label === "Coming soon" ? "--" : format(secs),
        stageText: showLocalMarketTime && m.tz ? stageEl.textContent : "Stage: " + stage,
        nowPct: pct(now)
      });
    });
    sortMarketsByStatus();
  }

  function updateTop(){
    const d=new Date();
    if (showUTC) {
      const hours = String(d.getUTCHours()).padStart(2, '0');
      const minutes = String(d.getUTCMinutes()).padStart(2, '0');
      const seconds = String(d.getUTCSeconds()).padStart(2, '0');
      document.getElementById("clock").textContent = `${hours}:${minutes}:${seconds} UTC`;
      document.getElementById("date").textContent = d.toUTCString().split(' ').slice(0, 4).join(' ');
      document.getElementById("timezone").textContent = "Timezone: UTC";
    } else {
      document.getElementById("clock").textContent=d.toLocaleTimeString();
      document.getElementById("date").textContent=d.toDateString();
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      document.getElementById("timezone").textContent = "Your Timezone: " + tz;
    }
  }

  renderLayout();
  loadFavorites();
  updateFavoriteButtons();
  refreshFavoritesSection();
  loadOrder();
  enableDragAndDrop();
  enableArrowReordering();
  applySearchAndFavoriteFilter();
  updateTop();
  updateMarkets();
  setInterval(()=>{ updateTop(); updateMarkets(); },1000);
});
</script>
</body>
</html>
